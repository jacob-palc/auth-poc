networks:
  netpulse-auth-network:
    driver: bridge

volumes:
  postgres_data:
  keycloak_data:

services:
  # PostgreSQL for Kong and Keycloak
  postgres:
    image: postgres:15-alpine
    container_name: netpulse-auth-postgres
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    networks:
      - netpulse-auth-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Keycloak Authentication Server (built from local source)
  keycloak:
    build:
      context: ./keycloak-source
      dockerfile: Dockerfile
    image: netpulse-keycloak:local
    container_name: netpulse-auth-keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak123
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_STRICT: false
      KC_PROXY: edge
    command: start-dev --import-realm
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    # No ports exposed - accessed only through Kong
    networks:
      - netpulse-auth-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;if timeout 5 grep -q '\"status\": \"UP\"' <&3; then exit 0; else exit 1; fi"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Kong API Gateway (built from local source, DB-less mode)
  kong:
    build:
      context: ./kong-source
      dockerfile: Dockerfile
    image: netpulse-kong:local
    container_name: netpulse-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002
      KONG_PLUGINS: bundled
    volumes:
      - ./kong/kong.yml:/etc/kong/kong.yml:ro
    ports:
      - "8000:8000"   # Proxy
      - "8443:8443"   # Proxy SSL
      - "8001:8001"   # Admin API
      - "8444:8444"   # Admin SSL
      - "8002:8002"   # Kong Manager
    networks:
      - netpulse-auth-network
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Mock NMS Server Service (internal only - accessed via Kong)
  nms-server:
    build:
      context: ./services/nms-server
      dockerfile: Dockerfile
    container_name: netpulse-mock-nms-server
    # No ports exposed - internal only
    networks:
      - netpulse-auth-network
    environment:
      SERVICE_NAME: nms-server
      SERVICE_PORT: 8080

  # Mock Telegraf API Service (internal only - accessed via Kong)
  telegraf-api:
    build:
      context: ./services/telegraf-api
      dockerfile: Dockerfile
    container_name: netpulse-mock-telegraf-api
    # No ports exposed - internal only
    networks:
      - netpulse-auth-network
    environment:
      SERVICE_NAME: telegraf-api
      SERVICE_PORT: 8080

  # Mock NetBox API Service (internal only - accessed via Kong)
  netbox-api:
    build:
      context: ./services/netbox-api
      dockerfile: Dockerfile
    container_name: netpulse-mock-netbox-api
    # No ports exposed - internal only
    networks:
      - netpulse-auth-network
    environment:
      SERVICE_NAME: netbox-api
      SERVICE_PORT: 8080

  # OpenLDAP for LDAP Integration
  openldap:
    image: osixia/openldap:1.5.0
    container_name: netpulse-openldap
    environment:
      LDAP_ORGANISATION: "NetPulse"
      LDAP_DOMAIN: "netpulse.local"
      LDAP_ADMIN_PASSWORD: "admin123"
      LDAP_CONFIG_PASSWORD: "config123"
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: "readonly"
      LDAP_READONLY_USER_PASSWORD: "readonly123"
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ./ldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap.ldif
    networks:
      - netpulse-auth-network
    command: --copy-service

  # phpLDAPadmin for LDAP management (optional)
  phpldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: netpulse-phpldapadmin
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: openldap
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "8090:80"
    networks:
      - netpulse-auth-network
    depends_on:
      - openldap
